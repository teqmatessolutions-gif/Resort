# Add these sections to the existing nginx_resort.conf file
# Add after the pommaapi location block (around line 136)

upstream orchid_backend {
    server 127.0.0.1:8011;
    keepalive 32;
}

# Orchid Admin Dashboard - /orchidadmin routes
location /orchidadmin {
    alias /var/www/resort/orchid_production/dasboard/build;
    try_files $uri $uri/ /orchidadmin/index.html;
}

location /orchidadmin/static/ {
    alias /var/www/resort/orchid_production/dasboard/build/static/;
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# Orchid Resort user interface - /orchid routes
location /orchid {
    alias /var/www/resort/orchid_production/userend/userend/build;
    try_files $uri $uri/ /orchid/index.html;
}

location /orchid/static/ {
    alias /var/www/resort/orchid_production/userend/userend/build/static/;
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# Orchid file uploads
location /orchidfiles/uploads/ {
    alias /var/www/resort/orchid_production/ResortApp/uploads/;
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# Orchid static files
location /orchidfiles/static/ {
    alias /var/www/resort/orchid_production/ResortApp/static/;
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# Orchid API routes - route to orchid_backend (orchiddb)
location /orchidapi/ {
    # Remove /orchidapi prefix before passing to backend
    rewrite ^/orchidapi/(.*)$ /$1 break;
    proxy_pass http://orchid_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    # Rewrite redirects from backend to include /orchidapi prefix
    proxy_redirect ~^https?://[^/]+/api/(.*)$ /orchidapi/api/$1;
    proxy_redirect /api/ /orchidapi/api/;
    proxy_buffering off;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}

